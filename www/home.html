<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/custom.css">
    <link rel="stylesheet" href="assets/css/custom.css">

   
    <title>Añadir un producto</title>
</head>
<body>
    
      
      
    <nav class="navbar navbar-inverse navbar-fixed-top">
        
    </nav>
    <div class="container-fluid mt-2">
    <h4>Alta de ususarios </h4>
        <form id="formularioAlta" class="mt-2">
            <div class="form-group">
                <label for="nombre">Nombre</label>
                <input type="text" class="form-control" name="nombre" id="nombre" placeholder="Nombre">
            </div>
            <div class="form-group">
                <label for="email">Correo</label>
                <input  type="email" class="form-control" name="email" id="email" placeholder="Email" rows="3"></input>
            </div>
            <div class="form-group">
                <label for="edad">Edad</label>
                <input type="text" class="form-control" name="edad" id="edad" placeholder="Edad">
            </div>
            <select class="form-select" name="sexo" id="sexo" aria-label="Default select example">
                <option selected>Sexo</option>
                <option value="M">M</option>
                <option value="F">F</option>
                
            </select>
            <select class="form-select" name="ciudad" id="ciudad" aria-label="Default select example">
                <option value="">-- Selecciona una provincia --</option>
                    <option value="alava">Álava</option>
                    <option value="albacete">Albacete</option>
                    <option value="alicante">Alicante</option>
                    <option value="almeria">Almería</option>
                    <option value="asturias">Asturias</option>
                    <option value="avila">Ávila</option>
                    <option value="badajoz">Badajoz</option>
                    <option value="barcelona">Barcelona</option>
                    <option value="burgos">Burgos</option>
                    <option value="caceres">Cáceres</option>
                    <option value="cadiz">Cádiz</option>
                    <option value="cantabria">Cantabria</option>
                    <option value="castellon">Castellón</option>
                    <option value="ciudad_real">Ciudad Real</option>
                    <option value="cordoba">Córdoba</option>
                    <option value="cuenca">Cuenca</option>
                    <option value="girona">Girona</option>
                    <option value="granada">Granada</option>
                    <option value="guadalajara">Guadalajara</option>
                    <option value="guipuzcoa">Guipúzcoa</option>
                    <option value="huelva">Huelva</option>
                    <option value="huesca">Huesca</option>
                    <option value="illes_balears">Illes Balears</option>
                    <option value="jaen">Jaén</option>
                    <option value="la_coruna">La Coruña</option>
                    <option value="la_rioja">La Rioja</option>
                    <option value="las_palmas">Las Palmas</option>
                    <option value="leon">León</option>
                    <option value="lleida">Lleida</option>
                    <option value="lugo">Lugo</option>
                    <option value="madrid">Madrid</option>
                    <option value="malaga">Málaga</option>
                    <option value="murcia">Murcia</option>
                    <option value="navarra">Navarra</option>
                    <option value="ourense">Ourense</option>
                    <option value="palencia">Palencia</option>
                    <option value="pontevedra">Pontevedra</option>
                    <option value="salamanca">Salamanca</option>
                    <option value="segovia">Segovia</option>
                    <option value="sevilla">Sevilla</option>
                    <option value="soria">Soria</option>
                    <option value="tarragona">Tarragona</option>
                    <option value="tenerife">Santa Cruz de Tenerife</option>
                    <option value="teruel">Teruel</option>
                    <option value="toledo">Toledo</option>
                    <option value="valencia">Valencia</option>
                    <option value="valladolid">Valladolid</option>
                    <option value="vizcaya">Vizcaya</option>
                    <option value="zamora">Zamora</option>
                    <option value="zaragoza">Zaragoza</option>
            </select>
            <div class="form-group mt-2">
                <label for="imgInp">Elegir Imagen</label>
                <input type="file" name="imgInp" id="imgInp"><br>
                <img id="imagen" width="100px" src="#">
            </div>
            <div class="form-check form-check-inline">
                <input class="" type="checkbox" id="aficion1" value="option1">
                <label class="form-check-label" for="aficion1">Cine</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="" type="checkbox" id="aficion2" value="option2">
                <label class="form-check-label" for="aficion2">Pasear</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="" type="checkbox" id="aficion3" value="option3">
                <label class="form-check-label" for="aficion3">Bailar</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="" type="checkbox" id="aficion4" value="option3">
                <label class="form-check-label" for="aficion4">Viajar</label>
              </div>
              <div><button type="button" id="botonGuardar" class="btn btn-primary mt-3">Guardar</button></div>
             
        </form>
    </div>
    

   
    



    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
   
    <script  src="assets/js/sendNotifye.js"></script>
    <script src="assets/alerts/js/iziToast.min.js"></script>
    <script type="module">
        
        // Inicializar Supabase
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        const supabaseUrl = "https://srcawgqnbyyzhbqpznpd.supabase.co"; // Reemplaza con tu URL de Supabase
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyY2F3Z3FuYnl5emhicXB6bnBkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM1NDEzODMsImV4cCI6MjA1OTExNzM4M30.DI8Ab7zicxcIo56rdrO6UE0T_zZ7TmHNFZe4a4Z7w-0"; 
        const BUCKET_NAME = "imagenes"; // Nombre del bucket en Supabase
        const supabase = createClient(supabaseUrl, supabaseKey);

        //autiticar usuarios
        async function autenticarUsuario() {
           // Autenticar al usuario (si no está autenticado)
            const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                email: "usuarios@admin.com",
                password: "12345678",
            });

            if (authError) {
                console.error("Error al autenticar al usuario:", authError);
                alert("Error al autenticar al usuario.");
                return;
            }
            if(authData){
                guardarUsuario();
            }

            //console.log("Usuario autenticado:", authData.user);
        }

    
        async function guardarUsuario() {
            
            const nombre = document.getElementById("nombre").value;
            const edad = document.getElementById("edad").value;
            const email = document.getElementById("email").value;
            /* Para obtener el texto */
            var combo = document.getElementById("sexo");
            var sexo = combo.options[combo.selectedIndex].text;
            console.log("sexo:"+sexo);
            
            const ciudad = document.getElementById("ciudad").value;
            const fileInput = document.getElementById("imgInp").files[0];
            
            console.log("longitud archivo:"+fileInput.size);
            
        let imageUrl = "";
        console.log("longitud archivo: "+fileInput.size);
        // Si el usuario sube una imagen, la subimos a Supabase Storage
        if (!fileInput || !['image/png', 'image/jpeg'].includes(fileInput.type)) {
            alert("Por favor, selecciona una imagen válida (PNG o JPEG).");
            return;
        }else{
            // Normalizar el nombre del archivo
            const normalizedFileName = fileInput.name
            .toLowerCase()
            .replace(/\s+/g, '_') // Reemplazar espacios por guiones bajos
            .replace(/[^a-z0-9._-]/g, ''); // Eliminar caracteres no válidos

            //si el archivo de imagen es correcto 
            const filePath = `${Date.now()}_${normalizedFileName}`;
            console.log(filePath);

            
            const { data, error } = await supabase.storage.from(BUCKET_NAME).upload(filePath, fileInput);
            if (error) {
                console.error("Error al subir la imagen:", error);
                alert("Error al subir la imagen.");
                return;
            }

            // Obtener URL pública de la imagen
            const { data: publicURL } = supabase.storage.from(BUCKET_NAME).getPublicUrl(filePath);
            imageUrl = publicURL.publicUrl;
        }

        // Obtener el ID del usuario autenticado (opcional si usas auth)
        const { data: userData } = await supabase.auth.getUser();
        const userId = userData?.user?.id || null;

        // Guardar datos del usuario en Supabase
        const { error } = await supabase
            .from("usuarios")
            .insert([{ nombre, edad, email, sexo, ciudad, image_url: imageUrl, user_id: userId }]);

        if (error) {
            console.error("Error al guardar el usuario:", error);
            alert("Error al guardar el usuario.");
        } else {
            alert("Usuario registrado con éxito.");
            listUsers();
        }
        };

           
        function readURL(input) {
            if (input.files && input.files[0]) { //Revisamos que el input tenga contenido
                var reader = new FileReader(); //Leemos el contenido
                
                reader.onload = function(e) { //Al cargar el contenido lo pasamos como atributo de la imagen de arriba
                $('#imagen').attr('src', e.target.result);
                }
                
                reader.readAsDataURL(input.files[0]);
            }
        }

        $("#imgInp").change(function() { //Cuando el input cambie (se cargue un nuevo archivo) se va a ejecutar de nuevo el cambio de imagen y se verá reflejado.
        readURL(this);
        });

        // Asociar el evento al botón
        document.getElementById("botonGuardar").addEventListener("click", autenticarUsuario);
</script>
  
   </body>
</html>